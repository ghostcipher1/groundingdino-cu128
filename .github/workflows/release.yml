name: Release to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Upload to Test PyPI instead of PyPI'
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  id-token: write  # Required for trusted publishing

jobs:
  build:
    name: Build distribution üì¶
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Full history for proper versioning
        persist-credentials: false

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools>=68 wheel build twine
        pip install -r requirements.txt

    - name: Verify version matches tag
      if: github.event_name == 'release'
      run: |
        pip install tomli
        TAG_VERSION="${GITHUB_REF#refs/tags/v}"
        python -c "
        import sys
        try:
            import tomllib
        except ImportError:
            import tomli as tomllib
        with open('pyproject.toml', 'rb') as f:
            version = tomllib.load(f)['project']['version']
        tag_version = '$TAG_VERSION'
        if tag_version != version:
            print(f'Error: Tag version ({tag_version}) does not match package version ({version})')
            sys.exit(1)
        print(f'‚úì Version verified: {version}')
        "

    - name: Build source distribution
      run: |
        python -m build --sdist --no-isolation
        ls -lh dist/

    - name: Check distribution
      run: |
        twine check dist/*

    - name: Store the distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Create release summary
      if: github.event_name == 'release'
      run: |
        VERSION=$(python -c "try: import tomllib;except: import tomli as tomllib;print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
        echo "## üì¶ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Package:** groundingdino-cu128" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "**Python Support:** 3.9, 3.10, 3.11, 3.12" >> $GITHUB_STEP_SUMMARY
        echo "**CUDA Support:** 12.6, 12.8" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install groundingdino-cu128" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  publish-to-pypi:
    name: Publish Python üêç distribution üì¶ to PyPI
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: pypi
      url: https://pypi.org/p/groundingdino-cu128
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Publish distribution üì¶ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true
        verbose: true

  publish-to-testpypi:
    name: Publish Python üêç distribution üì¶ to TestPyPI
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_pypi == 'true' || github.event_name == 'workflow_dispatch'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/groundingdino-cu128
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Publish distribution üì¶ to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        skip-existing: true
        verbose: true

  verify-installation:
    name: Verify PyPI installation
    needs: publish-to-pypi
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'

    - name: Wait for PyPI to update
      run: sleep 60

    - name: Install from PyPI
      run: |
        pip install groundingdino-cu128
        python -c "import groundingdino; print(f'‚úì groundingdino imported successfully')"
        python -c "import shadow_dino; print(f'‚úì shadow_dino imported successfully')"
        python -c "import shadow_dino; print(f'Version: {shadow_dino.__version__}')"

    - name: Verify dual imports
      run: |
        python -c "
        import groundingdino
        import shadow_dino
        print('‚úì Both import namespaces work')
        print(f'shadow_dino version: {shadow_dino.__version__}')
        print(f'CUDA available: {shadow_dino.__cuda_available__}')
        "
